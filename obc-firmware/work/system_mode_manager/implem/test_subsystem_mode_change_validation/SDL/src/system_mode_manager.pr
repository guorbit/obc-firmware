/* CIF PROCESS (286, 148), (164, 75) */
process System_Mode_Manager;
    /* CIF Keep Specific Geode Partition 'default' */
    /* CIF TEXT (1067, 306), (427, 308) */
    -- Text area for declarations and comments
    TIMER init_timer;
    
    dcl current_system_mode System_Mode_T;
    dcl target_system_mode System_Mode_T;
    dcl initial_system_mode System_Mode_T;
    
    dcl system_mode_idle System_Mode_T;
    
    dcl system_mode_status_report System_Mode_Status_Report_T;
    
    dcl eps_mode_status_report EPS_Mode_Status_Report_T;
    dcl comms_mode_status_report Comms_Mode_Status_Report_T;
    dcl deployer_mode_status_report Deployer_Mode_Status_Report_T;
    dcl adcs_mode_status_report ADCS_Mode_Status_Report_T;
    dcl payload_mode_status_report Payload_Mode_Status_Report_T;
    dcl pipeline_mode_status_report Pipeline_Mode_Status_Report_T;
    
    dcl init_successful T_Boolean;
    dcl init_try_count T_Int32;
    /* CIF ENDTEXT */
    /* CIF procedure (1521, 703), (153, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    procedure change_system_mode;
        /* CIF Keep Specific Geode Partition 'default' */
        /* CIF TEXT (23, 29), (296, 140) */
        -- Text area for declarations and comments
        
        -- exported procedure
        fpar
            in Target_System_Mode_In System_Mode_T;
        /* CIF ENDTEXT */
        /* CIF START (458, 58), (70, 35) */
        START;
            /* CIF task (339, 113), (306, 35) */
            task target_system_mode := target_system_mode_in;
            /* CIF return (475, 168), (35, 35) */
            return ;
    endprocedure;
    /* CIF START (2069, 314), (70, 35) */
    START;
        /* CIF task (1999, 364), (208, 128) */
        task current_system_mode := {
  eps_mode eps_idle,
  comms_mode comms_uplink,
  deployer_mode deployer_idle,
  adcs_mode adcs_idle,
  payload_mode payload_idle,
  pipeline_mode pipeline_idle
};
        /* CIF task (1958, 512), (291, 68) */
        task eps_mode_status_report := {
  eps_mode current_system_mode.eps_mode,
  eps_last_op mode_status_nop
};
        /* CIF task (1937, 600), (333, 68) */
        task comms_mode_status_report := {
  comms_mode current_system_mode.comms_mode,
  comms_last_op mode_status_nop
};
        /* CIF task (1926, 688), (354, 68) */
        task deployer_mode_status_report := {
  deployer_mode current_system_mode.deployer_mode,
  deployer_last_op mode_status_nop
};
        /* CIF task (1952, 776), (302, 68) */
        task adcs_mode_status_report := {
  adcs_mode current_system_mode.adcs_mode,
  adcs_last_op  mode_status_nop
};
        /* CIF task (1932, 864), (342, 68) */
        task payload_mode_status_report := {
  payload_mode current_system_mode.payload_mode,
  payload_last_op mode_status_nop
};
        /* CIF task (1931, 952), (345, 68) */
        task pipeline_mode_status_report := {
  pipeline_mode current_system_mode.pipeline_mode,
  pipeline_last_op mode_status_nop
};
        /* CIF task (1948, 1040), (311, 128) */
        task system_mode_status_report := {
  eps_report eps_mode_status_report,
  comms_report comms_mode_status_report,
  deployer_report deployer_mode_status_report,
  adcs_report adcs_mode_status_report,
  payload_report payload_mode_status_report,
  pipeline_report pipeline_mode_status_report
};
        /* CIF task (1993, 1188), (221, 128) */
        task initial_system_mode := {
  eps_mode eps_idle,
  comms_mode comms_uplink,
  deployer_mode deployer_idle,
  adcs_mode adcs_idle,
  payload_mode payload_imaging,
  pipeline_mode pipeline_idle
};
        /* CIF task (1961, 1331), (285, 35) */
        task target_system_mode := initial_system_mode;
        /* CIF task (1941, 1386), (325, 35) */
        task target_system_mode.eps_mode := eps_high_power;
        /* CIF task (2025, 1436), (157, 35) */
        task init_successful := False;
        /* CIF task (2035, 1491), (136, 35) */
        task init_try_count := 10;
        /* CIF join (2086, 1541), (35, 35) */
        join init_change_system_mode;
    /* CIF label (6226, 109), (106, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection pipeline_done:
        /* CIF decision (6170, 164), (218, 50) */
        decision current_system_mode.eps_mode;
            /* CIF ANSWER (6051, 234), (119, 23) */
            (eps_high_power):
                /* CIF output (5946, 277), (330, 35) */
                output change_eps_mode(target_system_mode.eps_mode);
                /* CIF NEXTSTATE (6065, 332), (92, 35) */
                NEXTSTATE Wait_EPS_2;
            /* CIF ANSWER (6410, 234), (70, 23) */
            else:
                /* CIF join (6427, 277), (35, 35) */
                join eps_skip_2;
        enddecision;
    /* CIF End Label */
    endconnection;
    /* CIF label (6378, 602), (100, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection pipeline_skip:
        /* CIF task (6120, 657), (616, 35) */
        task system_mode_status_report.pipeline_report.pipeline_mode := current_system_mode.pipeline_mode;
        /* CIF task (6174, 712), (508, 35) */
        task system_mode_status_report.pipeline_report.pipeline_last_op := mode_status_nop;
        /* CIF join (6411, 767), (35, 35) */
        join pipeline_done;
    /* CIF End Label */
    endconnection;
    /* CIF label (5121, 601), (99, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection payload_skip:
        /* CIF task (4864, 656), (613, 35) */
        task system_mode_status_report.payload_report.payload_mode := current_system_mode.payload_mode;
        /* CIF task (4918, 711), (506, 35) */
        task system_mode_status_report.payload_report.payload_last_op := mode_status_nop;
        /* CIF join (5154, 766), (35, 35) */
        join payload_done;
    /* CIF End Label */
    endconnection;
    /* CIF label (4053, 598), (94, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection comms_skip:
        /* CIF task (3801, 653), (599, 35) */
        task system_mode_status_report.comms_report.comms_mode := current_system_mode.comms_mode;
        /* CIF task (3852, 708), (497, 35) */
        task system_mode_status_report.comms_report.comms_last_op := mode_status_nop;
        /* CIF join (4083, 763), (35, 35) */
        join comms_done;
    /* CIF End Label */
    endconnection;
    /* CIF label (7538, 599), (87, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection eps_skip_2:
        /* CIF task (7314, 654), (536, 35) */
        task system_mode_status_report.eps_report.eps_mode := current_system_mode.eps_mode;
        /* CIF task (7354, 709), (455, 35) */
        task system_mode_status_report.eps_report.eps_last_op := mode_status_nop;
        /* CIF join (7565, 764), (35, 35) */
        join eps_done_2;
    /* CIF End Label */
    endconnection;
    /* CIF label (3059, 597), (87, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection eps_skip_1:
        /* CIF task (2835, 652), (536, 35) */
        task system_mode_status_report.eps_report.eps_mode := current_system_mode.eps_mode;
        /* CIF task (2875, 707), (455, 35) */
        task system_mode_status_report.eps_report.eps_last_op := mode_status_nop;
        /* CIF join (3086, 762), (35, 35) */
        join eps_done_1;
    /* CIF End Label */
    endconnection;
    /* CIF label (2921, 116), (93, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection eps_done_1:
        /* CIF output (2782, 171), (372, 35) */
        output change_comms_mode(target_system_mode.comms_mode);
        /* CIF NEXTSTATE (2918, 226), (100, 35) */
        NEXTSTATE Wait_Comms;
    /* CIF End Label */
    endconnection;
    /* CIF label (3447, 109), (101, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection comms_done:
        /* CIF output (3307, 164), (381, 35) */
        output change_payload_mode(target_system_mode.payload_mode);
        /* CIF NEXTSTATE (3447, 219), (102, 35) */
        NEXTSTATE Wait_Payload;
    /* CIF End Label */
    endconnection;
    /* CIF label (4744, 109), (105, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection payload_done:
        /* CIF output (4605, 164), (383, 35) */
        output change_pipeline_mode(target_system_mode.pipeline_mode);
        /* CIF NEXTSTATE (4745, 219), (103, 35) */
        NEXTSTATE Wait_Pipeline;
    /* CIF End Label */
    endconnection;
    /* CIF label (982, 946), (138, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection send_status_report:
        /* CIF output (850, 1001), (403, 35) */
        output relay_system_mode_status_report(system_mode_status_report);
        /* CIF NEXTSTATE (1002, 1056), (98, 35) */
        NEXTSTATE Wait_change;
    /* CIF End Label */
    endconnection;
    /* CIF label (1352, 702), (93, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    connection eps_done_2:
        /* CIF decision (1345, 757), (108, 50) */
        decision init_successful;
            /* CIF ANSWER (996, 827), (70, 23) */
            (True):
                /* CIF join (1013, 870), (35, 35) */
                join send_status_report;
            /* CIF ANSWER (1478, 827), (70, 23) */
            (False):
                /* CIF decision (1435, 870), (154, 50) */
                decision current_system_mode;
                    /* CIF ANSWER (1382, 940), (143, 23) */
                    (initial_system_mode):
                        /* CIF task (1377, 983), (153, 35) */
                        task init_successful := True;
                        /* CIF join (1437, 1033), (35, 35) */
                        join send_status_report;
                    /* CIF ANSWER (1557, 940), (70, 23) */
                    else:
                enddecision;
                /* CIF decision (1449, 1084), (126, 50) */
                decision init_try_count > 0;
                    /* CIF ANSWER (1592, 1154), (70, 23) */
                    (False):
                        /* CIF PROCEDURECALL (1512, 1231), (228, 35) */
                        call writeln("Completely failed to init");
                        /* CIF join (1609, 1281), (35, 35) */
                        join send_status_report;
                    /* CIF ANSWER (1266, 1154), (70, 23) */
                    (True):
                        /* CIF PROCEDURECALL (1128, 1197), (344, 35) */
                        call writeln("Init failed, should set timer and retry in 5sec");
                        /* CIF PROCEDURECALL (1208, 1252), (184, 35) */
                        call set_timer(5000, init_timer);
                        /* CIF task (1190, 1302), (221, 35) */
                        task init_try_count := init_try_count - 1;
                        /* CIF decision (1237, 1357), (126, 50) */
                        decision init_try_count = 7;
                            /* CIF ANSWER (1207, 1427), (70, 23) */
                            (true):
                                /* CIF task (1103, 1470), (277, 35) */
                                task target_system_mode.eps_mode := eps_idle;
                            /* CIF ANSWER (1392, 1427), (70, 23) */
                            (false):
                        enddecision;
                        /* CIF NEXTSTATE (1244, 1521), (113, 35) */
                        NEXTSTATE Wait_init_timer;
                enddecision;
        enddecision;
    /* CIF End Label */
    endconnection;
    /* CIF state (1515, 1357), (113, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    state Wait_init_timer;
        /* CIF input (1531, 1412), (80, 35) */
        input init_timer;
            /* CIF join (1554, 1467), (35, 35) */
            join init_change_system_mode;
    endstate;
    /* CIF state (2580, 599), (92, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    state Wait_EPS_1;
        /* CIF input (2448, 654), (326, 35) */
        input report_eps_mode_status(eps_mode_status_report);
            /* CIF decision (2494, 709), (234, 50) */
            decision eps_mode_status_report.eps_mode;
                /* CIF ANSWER (2396, 779), (212, 23) */
                (target_system_mode.eps_mode):
                    /* CIF task (2290, 822), (424, 35) */
                    task current_system_mode.eps_mode := target_system_mode.eps_mode;
                /* CIF ANSWER (2753, 779), (70, 23) */
                else:
            enddecision;
            /* CIF task (2399, 873), (424, 35) */
            task system_mode_status_report.eps_report := eps_mode_status_report;
            /* CIF join (2594, 923), (35, 35) */
            join eps_done_1;
    endstate;
    /* CIF state (3507, 600), (100, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    state Wait_Comms;
        /* CIF input (3372, 655), (368, 35) */
        input report_comms_mode_status(comms_mode_status_report);
            /* CIF decision (3418, 710), (276, 50) */
            decision comms_mode_status_report.comms_mode;
                /* CIF ANSWER (3301, 780), (233, 23) */
                (target_system_mode.comms_mode):
                    /* CIF task (3185, 818), (466, 35) */
                    task current_system_mode.comms_mode := target_system_mode.comms_mode;
                /* CIF ANSWER (3675, 780), (70, 23) */
                else:
            enddecision;
            /* CIF task (3323, 869), (466, 35) */
            task system_mode_status_report.comms_report := comms_mode_status_report;
            /* CIF join (3539, 919), (35, 35) */
            join comms_done;
    endstate;
    /* CIF state (4564, 602), (102, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    state Wait_Payload;
        /* CIF input (4427, 657), (378, 35) */
        input report_payload_mode_status(payload_mode_status_report);
            /* CIF decision (4473, 712), (286, 50) */
            decision payload_mode_status_report.payload_mode;
                /* CIF ANSWER (4319, 782), (237, 23) */
                (target_system_mode.payload_mode):
                    /* CIF task (4200, 820), (475, 35) */
                    task current_system_mode.payload_mode := target_system_mode.payload_mode;
                /* CIF ANSWER (4767, 782), (70, 23) */
                else:
            enddecision;
            /* CIF task (4379, 871), (475, 35) */
            task system_mode_status_report.payload_report := payload_mode_status_report;
            /* CIF join (4599, 921), (35, 35) */
            join payload_done;
    endstate;
    /* CIF state (5806, 603), (103, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    state Wait_Pipeline;
        /* CIF input (5680, 658), (380, 35) */
        input report_pipeline_mode_status(pipeline_mode_status_report);
            /* CIF decision (5726, 713), (288, 50) */
            decision pipeline_mode_status_report.pipeline_mode;
                /* CIF ANSWER (5608, 783), (238, 23) */
                (target_system_mode.pipeline_mode):
                    /* CIF task (5489, 821), (477, 35) */
                    task current_system_mode.pipeline_mode := target_system_mode.pipeline_mode;
                /* CIF ANSWER (6025, 783), (70, 23) */
                else:
            enddecision;
            /* CIF task (5632, 872), (477, 35) */
            task system_mode_status_report.pipeline_report := pipeline_mode_status_report;
            /* CIF join (5853, 927), (35, 35) */
            join pipeline_done;
    endstate;
    /* CIF state (7057, 600), (92, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    state Wait_EPS_2;
        /* CIF input (6927, 655), (326, 35) */
        input report_eps_mode_status(eps_mode_status_report);
            /* CIF decision (6973, 710), (234, 50) */
            decision eps_mode_status_report.eps_mode;
                /* CIF ANSWER (6854, 780), (212, 23) */
                (target_system_mode.eps_mode):
                    /* CIF task (6748, 818), (424, 35) */
                    task current_system_mode.eps_mode := target_system_mode.eps_mode;
                /* CIF ANSWER (7237, 780), (70, 23) */
                else:
            enddecision;
            /* CIF task (6878, 869), (424, 35) */
            task system_mode_status_report.eps_report := eps_mode_status_report;
            /* CIF join (7073, 919), (35, 35) */
            join eps_done_2;
    endstate;
    /* CIF state (2521, 61), (98, 35) */
    /* CIF Keep Specific Geode Partition 'default' */
    state Wait_change;
        /* CIF input (2495, 117), (153, 35) */
        input change_system_mode;
            /* CIF label (2482, 172), (179, 35) */
            init_change_system_mode:
            /* CIF decision (2463, 222), (218, 50) */
            decision current_system_mode.eps_mode;
                /* CIF ANSWER (2419, 292), (71, 23) */
                (eps_idle):
                    /* CIF output (2290, 335), (330, 35) */
                    output change_eps_mode(target_system_mode.eps_mode);
                    /* CIF NEXTSTATE (2409, 390), (92, 35) */
                    NEXTSTATE Wait_EPS_1;
                /* CIF ANSWER (2702, 292), (70, 23) */
                else:
                    /* CIF join (2719, 335), (35, 35) */
                    join eps_skip_1;
            enddecision;
    endstate;
endprocess System_Mode_Manager;